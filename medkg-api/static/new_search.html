<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedKG Advanced Search</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="css/custom.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <style>
        :root {
            --primary-color: #1c4966;
            --primary-light: #3e6b8a;
            --primary-dark: #0d2b3e;
            --secondary-color: #ff4081;
            --text-color: #333;
            --background-color: #f5f5f5;
        }

        body {
            display: flex;
            min-height: 100vh;
            flex-direction: column;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        main {
            flex: 1 0 auto;
        }

        nav {
            background-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            height: 140px;
        }

        nav .brand-logo {
            display: flex;
            align-items: center;
            padding: 0;
            height: 100%;
        }

        nav .brand-logo .logo-container {
            background-color: white;
            border-radius: 0 100% 100% 0;
            padding: 0px 35px 0px 12px;
            height: 100%;
            position: relative;
            align-items: center;
        }

        nav .brand-logo img {
            height: 140px;
            /* margin-right: 10px; */
        }

        nav .brand-logo span {
            color: var(--primary-color);
            font-weight: bold;
        }

        nav ul {
            padding-right: 2rem;
        }

        nav ul a {
            color: white;
            margin-top: 2rem;
            font-size: large;
        }

        .search-types {
            display: flex;
            justify-content: space-around;
            margin-top: 2rem;
        }

        .search-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            width: 30%;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .search-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .search-card.active {
            border: 2px solid var(--primary-color);
        }

        .search-card-icon {
            font-size: 3rem;
            color: var(--primary-color);
        }

        .search-card-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 1rem;
        }

        .search-content {
            margin-top: 2rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }

        .input-field input[type=text]:focus+label,
        .input-field input[type=number]:focus+label {
            color: var(--primary-color) !important;
        }

        .input-field input[type=text]:focus,
        .input-field input[type=number]:focus {
            border-bottom: 1px solid var(--primary-color) !important;
            box-shadow: 0 1px 0 0 var(--primary-color) !important;
        }

        .btn {
            background-color: var(--primary-color);
        }

        .btn:hover {
            background-color: var(--primary-light);
        }

        .collection .collection-item.avatar {
            min-height: 0;
        }

        footer {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 0;
        }

        #searchResults {
            margin-top: 2rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }

        #searchResults h5 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-light);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .result-card {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 1rem;
            transition: box-shadow 0.3s ease;
        }

        .result-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .result-card .card-content {
            padding: 16px;
        }

        .result-card .card-title {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .result-card .card-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            margin-top: 8px;
        }

        .result-card .card-type {
            background-color: var(--primary-light);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .result-card .card-id {
            color: #757575;
            font-size: 0.9rem;
        }

        .result-card .card-description {
            color: #424242;
            margin-bottom: 12px;
        }

        .result-card .card-actions {
            border-top: 1px solid #e0e0e0;
            padding-top: 12px;
            display: flex;
            justify-content: flex-end;
        }

        .result-card .card-actions a {
            color: var(--primary-color);
            margin-left: 16px;
            display: flex;
            align-items: center;
        }

        .result-card .card-actions a i {
            margin-right: 4px;
        }

        #pagination {
            display: flex;
            justify-content: center;
            margin-top: 2rem;
        }

        #pagination button {
            margin: 0 5px;
        }

        #noResults {
            text-align: center;
            color: #757575;
            font-style: italic;
        }

        footer .container {
            max-width: -webkit-fill-available;
            width: 100%;
            margin: 1px;
        }

        footer .logo-container {
            height: 100%;
            position: relative;
            align-items: center;
            padding: 0px 20px 0px 20px !important;
        }

        footer .logo-container img {
            height: 140px;
            /* margin-right: 10px; */
        }
    </style>
</head>

<body>
    <header>
        <nav>
            <div class="nav-wrapper">
                <a href="#" class="brand-logo">
                    <div class="logo-container">
                        <img src="images/logo-1.png" alt="MedKG Logo">
                    </div>
                </a>
                <ul id="nav-mobile" class="right hide-on-med-and-down">
                    <li><a href="search">Search</a></li>
                    <li><a href="search">Documentation</a></li>
                    <li><a href="api-docs">API Docs</a></li>
                    <li><a href="swagger">Swagger Docs</a></li>
                    <li><a href="https://github.com/chemplusx/MedKG" target="_blank">Github</a></li>
                    <li><a href="about-us">Project/Team</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <main class="container">
        <div class="search-types">
            <div class="search-card active" data-search-type="normal">
                <i class="material-icons search-card-icon">search</i>
                <div class="search-card-title">Global Search</div>
            </div>
            <div class="search-card" data-search-type="interaction">
                <i class="material-icons search-card-icon">device_hub</i>
                <div class="search-card-title">Interaction Search</div>
            </div>
            <div class="search-card" data-search-type="path">
                <i class="material-icons search-card-icon">timeline</i>
                <div class="search-card-title">Path Search</div>
            </div>
        </div>

        <div class="search-content">
            <div id="normal-search">
                <h5>Global Search</h5>
                <div class="input-field">
                    <input id="normalSearchTerm" type="text">
                    <label for="normalSearchTerm">Enter search term</label>
                </div>
                <div class="center-align">
                    <button id="normalSearchBtn" class="btn waves-effect waves-light">Search
                        <i class="material-icons right">search</i>
                    </button>
                </div>
            </div>

            <div id="interaction-search" style="display: none;">
                <h5>Interaction Search</h5>
                <div class="input-field">
                    <!-- <input class="autocomplete" name="node_search" id="node_search"
                        placeholder="Type the name of the node" />
                    <input type="hidden" name="node_search" id="network_f_name" value="1725318346" /> -->
                    <input class="autocomplete" name="interactionSearchTerm" id="interactionSearchTerm"
                        placeholder="Type the name of the node">
                    <input type="hidden" name="interactionSearchTerm" id="interactionSearchTerm_f_name" value="" />
                    <!-- <label for="interactionSearchTerm">Enter search term</label> -->
                </div>
                <div class="input-field">
                    <select id="destinationNodeType">
                        <option value="" disabled selected>Choose destination node type</option>
                        <option value="Gene">Gene</option>
                        <option value="Drug">Drug</option>
                        <option value="Disease">Disease</option>
                        <option value="Protein">Protein</option>
                        <option value="Metabolite">Metabolite</option>
                        <option value="Pathway">Pathway</option>
                    </select>
                    <label>Destination Node Type</label>
                </div>
                <div class="input-field">
                    <input id="searchDepth" type="number" min="1">
                    <label for="searchDepth">Search Depth</label>
                </div>
                <div class="center-align">
                    <button id="interactionSearchBtn" class="btn waves-effect waves-light">Search Interactions
                        <i class="material-icons right">device_hub</i>
                    </button>
                </div>
            </div>

            <div id="path-search" style="display: none;">
                <h5>Path Search</h5>
                <div class="input-field">
                    <input class="autocomplete" name="pathStartNode" id="pathStartNode">
                    <input type="hidden" name="pathStartNode" id="pathStartNode_f_name" value="">
                </div>
                <div class="input-field">
                    <input class="autocomplete" name="pathEndNode" id="pathEndNode">
                    <input type="hidden" name="pathEndNode" id="pathEndNode_f_name" value="">
                </div>
                <div class="input-field">
                    <input id="maxHops" type="number" min="-1">
                    <label for="maxHops">Max Hops</label>
                </div>
                <div class="center-align">
                    <button id="pathSearchBtn" class="btn waves-effect waves-light">Find Path
                        <i class="material-icons right">timeline</i>
                    </button>
                </div>
            </div>
        </div>

        <div id="searchResults" style="display: none;">
            <h5 class="center-align">Search Results</h5>
            <div id="resultsList"></div>
            <div id="noResults" style="display: none;">No results found</div>
            <div id="pagination">
                <button id="prevPage" class="btn-small waves-effect waves-light" disabled>
                    <i class="material-icons left">chevron_left</i>Previous
                </button>
                <button id="nextPage" class="btn-small waves-effect waves-light">
                    Next<i class="material-icons right">chevron_right</i>
                </button>
            </div>
        </div>
    </main>

    <footer class="page-footer">
        <div class="container">
            <div class="row">
                <div class="logo-container col">
                    <img src="images/logo-1.png" alt="MedKG Logo">
                </div>
                <div class="col l5 s12">
                    <h5 class="white-text" style="width: inherit;text-align: justify;"><strong>MedKG</strong></h5>
                    <p class="grey-text text-lighten-4" style="width: inherit;text-align: justify;">
                        <b>Department of Pharmacoinformatics</b>
                    </p>
                    <p class="grey-text text-lighten-4" style="width: inherit;text-align: justify;">
                        National Institute of Pharmaceutical
                        Education and Research,
                        S.A.S. Nagar (Mohali)
                    </p>
                </div>

                <div class="col offset-l2">
                    <h5 class="white-text">Links</h5>
                    <ul>
                        <li><a class="grey-text text-lighten-3" href="about-us">About Us</a></li>
                        <li><a class="grey-text text-lighten-3" href="contact">Contact</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="footer-copyright">
            <div class="container">
                Â© 2024 ChemPlusX. All rights reserved.
            </div>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="js/search_in_graph.js"></script>
    <link rel="stylesheet" href="css/search.css">
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            M.AutoInit();

            const searchCards = document.querySelectorAll('.search-card');
            const searchContents = document.querySelectorAll('.search-content > div');

            searchCards.forEach(card => {
                card.addEventListener('click', () => {
                    const searchType = card.getAttribute('data-search-type');

                    searchCards.forEach(c => c.classList.remove('active'));
                    card.classList.add('active');

                    searchContents.forEach(content => {
                        content.style.display = content.id === `${searchType}-search` ? 'block' : 'none';
                    });
                });
            });
        });

        function performSearch(searchType) {
            let searchTerm, destinationNodeType, depth, startNode, endNode, maxHops;

            switch (searchType) {
                case 'global':
                    searchTerm = document.getElementById('normalSearchTerm').value;
                    break;
                case 'interaction':
                    searchTerm = document.querySelector('#interactionSearchTerm_f_name').value;
                    destinationNodeType = document.getElementById('destinationNodeType').value;
                    depth = document.getElementById('searchDepth').value;
                    break;
                case 'path':
                    startNode = document.getElementById('pathStartNode_f_name').value;
                    endNode = document.getElementById('pathEndNode_f_name').value;
                    maxHops = document.getElementById('maxHops').value;
                    break;
            }

            // Simulated API call - replace with actual API endpoint
            fetch(`api/${searchType}-search`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    searchTerm, destinationNodeType, depth, startNode, endNode, maxHops
                }),
            })
                .then(response => response.json())
                .then(data => displayResults(data, searchType))
                .catch(error => console.error('Error:', error));
        }

        function displayResults(results, searchType) {
            const resultsList = document.getElementById('resultsList');
            const noResults = document.getElementById('noResults');
            resultsList.innerHTML = '';

            if (results.length === 0) {
                noResults.style.display = 'block';
                resultsList.style.display = 'none';
            } else {
                noResults.style.display = 'none';
                resultsList.style.display = 'block';

                if (searchType === 'interaction' || searchType === 'path') {
                    const resultsList = document.getElementById('resultsList');
                    results.paths.forEach((result, index) => {
                        const card = createPathVisualization(result, index);
                        resultsList.appendChild(card);
                    });

                    // Animate nodes
                    setTimeout(() => {
                        const nodes = document.querySelectorAll('.path-node');
                        nodes.forEach((node, index) => {
                            setTimeout(() => {
                                node.style.opacity = 1;
                                node.style.transform = 'scale(1)';
                            }, index * 100);
                        });
                    }, 100);
                    
                }else{
                    results.forEach(result => {
                        const card = document.createElement('div');
                        card.className = 'result-card';
                        card.innerHTML = `
                            <div class="card-content">
                                <span class="card-title">${result.display_name || result.name || result.label} (${result.properties.id || 'N/A'}) </span>
                                <div class="card-info">
                                    <span class="card-type">${result.type}</span>
                                    <span class="card-id">ID: ${result.id}</span>
                                </div>
                                <p class="card-description">${result.properties.description || result.properties.function || 'No description available.'}</p>
                                <div class="card-actions">
                                    <a href="visualise?id=${result.id}&name=${result.label}&type=${result.type}" onclick="visualize('${result.id}')">
                                        <i class="material-icons">visibility</i>Visualize
                                    </a>
                                    <a href="#!" onclick="showDetails('${result.id}')">
                                        <i class="material-icons">info</i>Details
                                    </a>
                                </div>
                            </div>
                        `;
                        resultsList.appendChild(card);
                    });
                }
            }

            document.getElementById('searchResults').style.display = 'block';
        }

        const nodeTypeColors = {
            'Drug': '#FF6B6B',
            'Protein': '#4ECDC4',
            'Disease': '#45B7D1',
            'Peptide': '#FFA07A',
            'Transcript': '#98D8C8',
            'Gene': '#F7DC6F',
            'Pathway': '#C39BD3',
            'Metabolite': '#7DCEA0'
        };

        function getNodeColor(nodeType) {
            return nodeTypeColors[nodeType] || '#A9A9A9'; // Default color if type not found
        }

        function createPathVisualization(result, index) {
            const card = document.createElement('div');
            card.className = 'result-card';
            const startNode = result.nodes[0];
            const endNode = result.nodes[result.nodes.length - 1];
            
            let pathVisualization = '<div class="path-visualization">';
            result.nodes.forEach((node, nodeIndex) => {
                const nodeColor = getNodeColor(node.Node_Type);
                pathVisualization += `
                <div class="path-node">
                        <div class="node-icon" style="background-color: ${nodeColor};">${node.label[0]}</div>
                        <div class="node-label">${node.label}</div>
                        <div class="node-id">(${node.Node_Type})</div>
                    </div>
                `;
                
                if (nodeIndex < result.relationships.length) {
                    const rel = result.relationships[nodeIndex];
                    pathVisualization += `
                        <div class="path-relationship">
                            <div class="relationship-line"></div>
                            <div class="relationship-label">${rel.label}</div>
                        </div>
                    `;
                }
            });
            pathVisualization += '</div>';

            card.innerHTML = `
                <div class="card-content">
                    <span class="card-title">Path ${index + 1} (Length: ${result.length})</span>
                    <div class="card-info">
                        <span class="card-type">Path</span>
                        <span class="card-id"><strong>Start:</strong> ${startNode.label} (${startNode.Node_Type}), <strong>End:</strong> ${endNode.label} (${endNode.Node_Type})</span>
                    </div>
                    ${pathVisualization}
                    <div class="card-actions">
                        <a href="#!" onclick="visualizePath('${index}')">
                            <i class="material-icons">visibility</i>Visualize
                        </a>
                        <a href="#!" onclick="showPathDetails('${index}')">
                            <i class="material-icons">info</i>Details
                        </a>
                    </div>
                </div>
            `;

            return card;
        }


        function visualize(id) {
            // Implement visualization logic here
            console.log(`Visualizing node with ID: ${id}`);
        }

        function showDetails(id) {
            // Implement details view logic here
            console.log(`Showing details for node with ID: ${id}`);
        }

        // Add event listeners for pagination
        document.getElementById('prevPage').addEventListener('click', () => {
            // Implement previous page logic
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            // Implement next page logic
        });

        document.addEventListener('DOMContentLoaded', function () {
            var autoCompleteElem = document.querySelector('#interactionSearchTerm');
            var autoCompleteElem2 = document.querySelector('#pathStartNode');
            var autoCompleteElem3 = document.querySelector('#pathEndNode');
            var autoCompleteInstance = M.Autocomplete.init(autoCompleteElem, {
                minLength: 1,
                onAutocomplete: function (selectedValue) {
                    console.log('Selected:', selectedValue);
                    const value = this.options.data[selectedValue].value;
                    document.querySelector('#interactionSearchTerm_f_name').value = value.id;
                }
            });
            var autoCompleteInstance2 = M.Autocomplete.init(autoCompleteElem2, {
                minLength: 1,
                onAutocomplete: function (selectedValue) {
                    console.log('Selected:', selectedValue);
                    const value = this.options.data[selectedValue].value;
                    document.querySelector('#pathStartNode_f_name').value = value.id;
                }
            });
            var autoCompleteInstance3 = M.Autocomplete.init(autoCompleteElem3, {
                minLength: 1,
                onAutocomplete: function (selectedValue) {
                    console.log('Selected:', selectedValue);
                    const value = this.options.data[selectedValue].value;
                    document.querySelector('#pathEndNode_f_name').value = value.id;
                }
            });

            // Debounce function to limit API calls
            function debounce(func, wait) {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            // Function to fetch autocomplete suggestions from API
            async function fetchAutocompleteSuggestions(query, aci) {
                try {
                    const response = await fetch(`/search_in_graph?limit=10&term=${encodeURIComponent(query)}`);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const data = await response.json();

                    // Transform the data into the format Materialize expects
                    const autocompleteData = {};
                    data.forEach(item => {
                        const key = item.label + ":" + item.properties.id + " (" + item.type + ")";
                        autocompleteData[key] = {
                            value: item,
                            imageSrc: "images/" + getImageName(item) // Assuming `item.icon` contains the image URL
                        };
                    });

                    // Update the autocomplete data
                    aci.updateData(autocompleteData);
                    aci.open();

                    // Add images to the dropdown
                    setTimeout(() => {
                        const dropdownItems = document.querySelectorAll('.autocomplete-content li');
                        dropdownItems.forEach(item => {
                            const key = item.textContent.trim();
                            if (autocompleteData[key]) {
                                const img = item.querySelector('img')
                                // const img = document.createElement('img');
                                img.src = autocompleteData[key].imageSrc;
                                img.style.width = '30px';
                                img.style.height = '30px';
                                img.style.marginRight = '10px';
                                item.prepend(img);
                            }
                        });
                    }, 0);

                } catch (error) {
                    console.error('Error fetching autocomplete suggestions:', error);
                }
            }

            // Debounced version of the fetch function
            const debouncedFetch = debounce(fetchAutocompleteSuggestions, 300);

            // Add event listener for input changes
            autoCompleteElem.addEventListener('input', function (e) {
                const query = e.target.value;
                if (query.length >= 1) {
                    debouncedFetch(query, autoCompleteInstance);
                }
            });
            autoCompleteElem2.addEventListener('input', function (e) {
                const query = e.target.value;
                if (query.length >= 1) {
                    debouncedFetch(query, autoCompleteInstance2);
                }
            });
            autoCompleteElem3.addEventListener('input', function (e) {
                const query = e.target.value;
                if (query.length >= 1) {
                    debouncedFetch(query, autoCompleteInstance3);
                }
            });
        });

        document.getElementById('normalSearchBtn').addEventListener('click', () => performSearch('global'));
        document.getElementById('interactionSearchBtn').addEventListener('click', () => performSearch('interaction'));
        document.getElementById('pathSearchBtn').addEventListener('click', () => performSearch('path'));
    </script>
</body>

</html>